<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeClub DApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 2rem;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        h2 {
            font-size: 1.25rem;
            margin-top: 0;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        .btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: #eff6ff;
        }

        .card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .stat {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .proposal-card {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background: #e5e7eb;
            color: #374151;
        }

        .badge.open {
            background: #dcfce7;
            color: #166534;
        }

        .badge.closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.executed {
            background: #dbeafe;
            color: #1e40af;
        }

        .vote-bar {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            align-items: center;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>SafeClub</h1>
            <button id="connectBtn" class="btn">Connect Wallet</button>
        </div>

        <div id="app" style="display: none;">

            <!-- Stats Section -->
            <div class="grid" style="margin-bottom: 1.5rem;">
                <div class="card">
                    <div class="stat">Vault Balance</div>
                    <div class="stat-value" id="vaultBalance">0.0 ETH</div>
                </div>
                <div class="card">
                    <div class="stat">Total Members</div>
                    <div class="stat-value" id="memberCount">0</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid">
                <!-- Deposit -->
                <div class="card">
                    <h2>üí∞ Deposit</h2>
                    <div class="input-group">
                        <label>Amount (ETH)</label>
                        <input type="number" step="0.01" id="depositAmount" placeholder="0.1">
                    </div>
                    <button onclick="deposit()" class="btn">Deposit Funds</button>
                </div>

                <!-- Create Proposal -->
                <div class="card">
                    <h2>üìù New Proposal</h2>
                    <div class="input-group">
                        <label>Description</label>
                        <input type="text" id="propDesc" placeholder="e.g. Buy Coffee">
                    </div>
                    <div class="input-group">
                        <label>Recipient Address</label>
                        <input type="text" id="propRecipient" placeholder="0x...">
                    </div>
                    <div class="input-group">
                        <label>Amount (ETH)</label>
                        <input type="number" step="0.01" id="propAmount" placeholder="0.1">
                    </div>
                    <!-- Simplified duration for demo: constant or dropdown -->
                    <button onclick="createProposal()" class="btn">Create Proposal (60s)</button>
                </div>
            </div>

            <!-- Proposals List -->
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Proposals</h2>
                    <button onclick="loadProposals()" class="btn-outline" style="font-size:0.875rem;">Refresh</button>
                </div>
                <div id="proposalsList">
                    <p>Loading...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const ABI = [
            "function deposit() external payable",
            "function vaultBalance() external view returns (uint256)",
            "function memberCount() external view returns (uint256)",
            "function proposalCount() external view returns (uint256)",
            "function getProposal(uint256 id) external view returns (tuple(uint256 amount, address recipient, string description, uint256 deadline, bool executed, uint256 yesVotes, uint256 noVotes))",
            "function createProposal(uint256 amount, address recipient, string description, uint256 durationSeconds) external returns (uint256)",
            "function vote(uint256 id, bool support) external",
            "function execute(uint256 id) external",
            "event ProposalCreated(uint256 indexed id, address indexed creator, address indexed recipient, uint256 amount, uint256 deadline, string description)"
        ];

        let provider, signer, contract;
        let userAddress;

        const connectBtn = document.getElementById('connectBtn');
        const appDiv = document.getElementById('app');

        // === Connect ===
        connectBtn.addEventListener('click', async () => {
            if (!window.ethereum) return alert("MetaMask not found!");

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                connectBtn.innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
                appDiv.style.display = 'block';

                refreshData();
            } catch (err) {
                console.error(err);
                alert("Connection failed: " + err.message);
            }
        });

        async function refreshData() {
            try {
                const balance = await contract.vaultBalance();
                document.getElementById('vaultBalance').innerText = ethers.formatEther(balance) + " ETH";

                const count = await contract.memberCount();
                document.getElementById('memberCount').innerText = count.toString();

                loadProposals();
            } catch (err) {
                console.error("Error fetching data:", err);
            }
        }

        // === Actions ===
        async function deposit() {
            const amt = document.getElementById('depositAmount').value;
            if (!amt) return;
            try {
                const tx = await contract.deposit({ value: ethers.parseEther(amt) });
                await tx.wait();
                alert("Deposit successful!");
                refreshData();
            } catch (err) {
                console.error(err);
                alert("Error: " + (err.reason || err.message));
            }
        }

        async function createProposal() {
            const desc = document.getElementById('propDesc').value;
            const recipient = document.getElementById('propRecipient').value;
            const amt = document.getElementById('propAmount').value;

            if (!desc || !recipient || !amt) return alert("Fill all fields");

            if (!ethers.isAddress(recipient)) {
                return alert("Invalid Ethereum Address! Please use a 0x address.");
            }

            try {
                // Hardcoded 60 seconds duration for easy testing
                const tx = await contract.createProposal(
                    ethers.parseEther(amt),
                    recipient,
                    desc,
                    60
                );
                await tx.wait();
                alert("Proposal created!");
                refreshData();
            } catch (err) {
                console.error(err);
                alert("Error: " + (err.reason || err.message));
            }
        }

        async function vote(id, support) {
            try {
                const tx = await contract.vote(id, support);
                await tx.wait();
                alert("Voted!");
                loadProposals();
            } catch (err) {
                console.error(err);
                alert("Error: " + (err.reason || err.message));
            }
        }

        async function executeChain(id) {
            try {
                const tx = await contract.execute(id);
                await tx.wait();
                alert("Executed!");
                loadProposals();
                refreshData(); // Balance changes
            } catch (err) {
                console.error(err);
                alert("Error: " + (err.reason || err.message));
            }
        }

        // === Render Proposals ===
        async function loadProposals() {
            const list = document.getElementById('proposalsList');
            list.innerHTML = "Loading...";

            try {
                const pCount = await contract.proposalCount();
                let html = "";

                // Loop in reverse to show newest first
                for (let i = Number(pCount) - 1; i >= 0; i--) {
                    const p = await contract.getProposal(i);

                    const deadline = new Date(Number(p.deadline) * 1000);
                    const isExpired = new Date() > deadline;
                    const status = p.executed ? "Executed" : (isExpired ? "Closed" : "Active");
                    const badgeClass = p.executed ? "executed" : (isExpired ? "closed" : "open");

                    html += `
                <div class="proposal-card">
                    <div class="proposal-header">
                        <strong>#${i} ${p.description}</strong>
                        <span class="badge ${badgeClass}">${status}</span>
                    </div>
                    <div style="font-size:0.9rem; margin-bottom:0.5rem;">
                        <div>To: ${p.recipient.slice(0, 6)}...${p.recipient.slice(-4)}</div>
                        <div>Amount: ${ethers.formatEther(p.amount)} ETH</div>
                        <div>Deadline: ${deadline.toLocaleString()}</div>
                    </div>
                    <div class="vote-bar">
                        <span style="color:green">Yes: ${p.yesVotes}</span>
                        <span style="color:red">No: ${p.noVotes}</span>
                        
                        ${!p.executed && !isExpired ? `
                            <button class="btn-outline" onclick="vote(${i}, true)">Vote Yes</button>
                            <button class="btn-outline" onclick="vote(${i}, false)">Vote No</button>
                        ` : ''}

                        ${!p.executed && isExpired ? `
                            <button class="btn" onclick="executeChain(${i})">Execute</button>
                        ` : ''}
                    </div>
                </div>
                `;
                }

                if (Number(pCount) === 0) list.innerHTML = "<p>No proposals yet.</p>";
                else list.innerHTML = html;

            } catch (err) {
                console.error(err);
                list.innerHTML = `<p style="color:red">Error loading proposals: ${err.reason || err.message}</p>`;
            }
        }
    </script>

</body>

</html>